<html>
    <head>
        <title>troll</title>
    </head>
    <body>
        <script>const plugins = [];</script>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="components.js"></script>
        <script src="workerPlugin.js"></script>
        <script src="taskPlugin.js"></script>
        <script src="workerList.js"></script>
        <script src="workerInfo.js"></script>
        <script src="taskList.js"></script>
        <script src="actions.js"></script>
        <script>
            const events = [
                {type: 'createWorker', payload: { name: 'bob' } },
                {type: 'createWorker', payload: { name: 'kevin' } },
                {type: 'createWorker', payload: { name: 'stuart' } },
                {type: 'createTask', payload: { name: 'cleaning up', type: 'cleaning', time: 100 } },
                {type: 'createTask', payload: { name: 'make chaos', type: 'chaos', time: 100 } },
                {type: 'asignTask', payload: { worker: 'ID1', task: 'ID4' } },
                {type: 'trainWorker', payload: { worker: 'ID1', type: 'cleaning' } },
                {type: 'trainWorker', payload: { worker: 'ID2', type: 'chaos' } }
            ];

            function recalculateState() {
                var idCounter = 0;

                const tools = {
                    id: function() {
                        idCounter++;
                        return 'ID' + idCounter
                    }
                };

                const state = {
                };

                plugins.forEach(function(plugin) {
                    if (plugin.prepareState) {
                        plugin.prepareState(state);
                    }
                });

                events.forEach(function(event) {
                    plugins.forEach(function(plugin) {
                        if (plugin.mutators[event.type]) {
                            plugin.mutators[event.type](tools, state, event);
                        }
                    });
                });

                plugins.forEach(function(plugin) {
                    plugin.enrichers.forEach(function(enricher) {
                        enricher(tools, state);
                    });
                });

                console.log(state);
                return state;
            }

            var Icon = {
                view: function(vnode) {
                    return m('canvas', { id: 'example', width: vnode.attrs.width, height: vnode.attrs.height });
                },
                oncreate: function(vnode) {
                    const height = vnode.attrs.height;
                    const width = vnode.attrs.width;

                    const canvas = vnode.dom;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = "rgba("+vnode.attrs.color1+",0.1)";
                    for (var x = 0; x < Math.floor(width/2); x++) {
                        ctx.fillRect(x, 0, Math.floor(width/2), height);
                    }
                    ctx.fillStyle = "rgba("+vnode.attrs.color2+",0.1)";
                    for (var x = 0; x < Math.floor(width/4); x++) {
                        ctx.fillRect(x+Math.floor(width/4), 0, Math.floor(width/4), height);
                    }

                    console.log(canvas.toDataURL());
                }
            };

            var Game = {
                view: function() {
                    const state = recalculateState();

                    return m("main", [
                        m(Title, "troll management"),
                        m(Icon, {width: 128, height: 128, color1: '200,0,0', color2: '200,200,0'}),
                        m(Icon, {width: 64, height: 64, color1: '200,0,200', color2: '200,200,0'}),
                        m(Icon, {width: 32, height: 32, color1: '200,0,0', color2: '200,0,200'}),
                        m(Block, m(WorkerInfo, { state: state })),
                        m(Block, m(WorkerList, { state: state })),
                        m(Block, m(TaskList, { state: state })),
                        m(Button, { onclick: function() {
                            actions.endTurn();
                        } }, 'end turn')
                    ])
                }
            };

            var root = document.body

            m.mount(root, Game);
        </script>
    </body>
</html>
